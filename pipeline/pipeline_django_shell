pipeline {
    agent any

    options {
      disableConcurrentBuilds()
      disableRestartFromStage()
      disableResume()
      quietPeriod 30
      timeout(activity: true, time: 15)
      ansiColor('xterm')
      buildDiscarder logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '1', numToKeepStr: '5')
    }
    
    
    stages {
        stage('Enter commands') {
            steps {
                script { 
                    properties([parameters([text(defaultValue: 'sa', description: 'sasasa', name: 'COMMANDS_LIST')]), [$class: 'JobLocalConfiguration', changeReasonComment: '']])
                }
            }
        }
        stage('setup email and get commands') {
            steps {
                wrap([$class: 'BuildUser']) {
                  script {
                        env.EMAIL_TO=sh(returnStdout: true, script: "echo ${BUILD_USER_EMAIL} | sed 's/@.*//' |sed 's/\$/@gmail.com/' ")
                        env.APP_NAME= "python_test"       
                        env.APP_NAME_LOWER= env.APP_NAME.toLowerCase()
                  }
                }
            }
        }
        stage('read line by line') {
            steps {
                script { 
                    tmp_params = sh (script: 'echo "${COMMANDS_LIST}"', returnStdout: true).trim()
                    env.custom_var = tmp_param
                    echo ${env.custom_var}
                    
                    def lines = "${COMMANDS_LIST}"
                    def linesA = lines.toString().split('\n')
                    echo "${linesA}"
                    env.COMMANDSLIST="${linesA}"
                    writeFile file: 'file1.py', text: '${COMMANDS_LIST}"'
                }
            } 
        }
        stage('CLONE  ansible repo') {
            steps {
                checkout changelog: false, 
                poll: false, 
                scm: scmGit(branches: [[name: '*/**']],
                extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'ansible'], localBranch('main')],
                userRemoteConfigs: [[credentialsId: 'GITHUB_TOKEN', url: 'https://github.com/mohammadsereshki/ansible.git']])
            }
        }
        stage('run ansible') {
            steps {
                ansiblePlaybook colorized: true, 
                extras: "-e jenkins_pipeline_path=${workspace} ",
                inventory: '${workspace}/ansible/inventory/capex_uat.ini', 
                playbook: '${workspace}/ansible/django_shell/main.yml', 
                vaultCredentialsId: 'vault_pass', vaultTmpPath: ''
            }
            
        }
    }

}
